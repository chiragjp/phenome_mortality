---
title: "spline.R"
date: "April 9, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
```

This is code for mortality analysis on the NHANES data using spline modeling. First load all library dependencies, you likely won't want to suppress messages if this is your first time running.

```{r}
library(survival) # required for coxph function
library(pspline)  # required for stratified analysis
#library(polycor)    
#library(Hmisc)     
library(broom)
library(metafor)  # meta-analysis package
```

In the `nhanes_schema_merged_all_031816.Rdata` file you can load with the Dropbox or custom path. `bigData` and `tabDesc` in the new NHANES data maps with `MainTable` and `VarDescription` from the Scientific Data paper. I remapped this data so you could comment out this section and for the most part still run the code as-is if you wanted to use the package version or prior data.

```{r}
#load('~/Dropbox (RagGroup)/RagGroup Team Folder/nhanes_merged_data/nhanes_schema_merged_all_031816.Rdata')
load('~/src/phenome-mortality/nhanes_schema_merged_all_031816.Rdata')

MainTable <- bigData
VarDescription <- tabDesc
## create a new 'area' variable that is a combination of the SDMVPSU and SDMVSTRA
MainTable$area <- paste(MainTable$SDMVPSU, MainTable$SDMVSTRA, sep='_')

rm(bigData)
rm(tabDesc)
```

What shall we use as predictors of death? Central question includes what phenotypes and diagnostic markers are associated with survival in the US population. This is important as these markers are used in the clinic for diagnosis of disease.

There are 66 EWAS categories or unique `VarDescription$var_desc_ewas`. We subset and use 13 of them defined in `useTheseCategories` to be associated with mortality. We subset the data for the cohorts defined by the years in `useTheseSeries`.

```{r}
length( names(table(VarDescription$var_desc_ewas)) ) # 66 unique

useTheseCategories <- c('autoantibody', 'biochemistry', 'blood', 'blood pressure', 'body measures', 'cognitive functioning', 'cotinine', 'dermatology', 'hormone', 'physical fitness', 'physical functioning', 'sleep', 'spirometry') # variables we will associate with death
useTheseSeries <- c('1999-2000', '2001-2002', '2003-2004', '2005-2006', '2007-2008', '2009-2010') # patient cohort series we're using, only up to latest series with mortality data

VarDescription.2 <- VarDescription[VarDescription$var_desc_ewas %in% useTheseCategories & VarDescription$series %in% useTheseSeries, ]
```

Do a quick table to see the variable distribution, there are about 1,484 unique ones. We subset the list based on prefix using what's defined in `beginWith` and store that in `VarDescription.3`. This brings down the list of variables to 339.

```{r}
head( table(VarDescription.2$var, VarDescription.2$series) ) # Variables by cohort year,
dim( table(VarDescription.2$var, VarDescription.2$series) )  # 1,484 unique variables.

beginWith <- c('LBX', 'LBD', 'URX', 'URD', 'DXX', 'MGX', 'MSD', 'MSX', 'SPX', 'DEX', 'MSYS', 'MDIS', 'BAX', 'CVD', 'BPX', 'BMX') # variables that were continuous and of clinical relevance, previously had 'BIX'
VarDescription.2$first3 <- substr(VarDescription.2$var, 1, 3)
VarDescription.2$first4 <- substr(VarDescription.2$var, 1, 4)
VarDescription.3 <- VarDescription.2[VarDescription.2$first3 %in% beginWith |
                                     VarDescription.2$first4 %in% beginWith, ]

head( table(VarDescription.3$var, VarDescription.3$series) ) # Variables by cohort year,
dim( table(VarDescription.3$var, VarDescription.3$series) )  # 339 unique variables.
```

Choose phenotypic markers that are present >= 3 surveys. Since some variables appear more than once in a given survey year we map the counts > 1 to just 1 to indicate presence then sum across the rows to find unique counts across survey years. The counts >= 3 are the variables of interest and we display the original table subsetted as a sanity check. Our final list of variables present in >= 3 surveys is 181.

```{r}
VarDescription.3.table <- table(VarDescription.3$var, VarDescription.3$series)
VarSurveyCounts <- t( apply(VarDescription.3.table, 1, function(x) {ifelse(x >= 1, 1, 0)}) )
FinalVariableList <- rownames(VarSurveyCounts)[apply(VarSurveyCounts, 1, sum) >= 3]

head( VarDescription.3.table[rownames(VarDescription.3.table) %in% FinalVariableList, ] ) # sanity check if wanted

length(FinalVariableList) # final list of variables is 181
```

Some data points are duplicates (e.g., SI measurements). Find all the lab measures that end in SI suffix and store in `SIduplicates` as the search space. Find variables that exist in whole text plus again with SI appended to the end and log it in new list while removing from the `FinalVariableList`.

Also remove the redundant 1/Creatinine (`LBXSCRINV`) and triglyceride (`LBXSTR`) measures.

```{r}
SIduplicates <- FinalVariableList[grep("SI$", FinalVariableList)]
length(SIduplicates) # 41 potential duplicates

SIduplicates.removed <- c("URXCRS", "URXUMS") # manually add these measures

for (i in SIduplicates) {
  root <- substr(i, 1, nchar(i)-2) # variable w/o SI suffix
  
  if (root %in% FinalVariableList) { # check for duplicate non-SI measurement 
    SIduplicates.removed <- c(SIduplicates.removed, i)
  } else if (regexpr("^.{2}D.*", root) > 0) {
    if (paste0(substr(root, 1, 2), "X", substr(root, 4, nchar(root))) %in% FinalVariableList) {
      SIduplicates.removed <- c(SIduplicates.removed, i)
    }
  }
}

SIduplicates.removed # only 4 duplicated measurements reported as SI

FinalVariableList <- FinalVariableList[!(FinalVariableList %in% SIduplicates.removed)] # remove the SI imposters

FinalVariableList <- FinalVariableList[FinalVariableList != "LBXSCRINV"] # remove the redundant inverted creatinine measure
FinalVariableList <- FinalVariableList[FinalVariableList != "LBXSTR"] # remove the duplicated triglyceride measure

length(FinalVariableList) # final variable list is now 153
```

Before we go further let's review our chosen variables.

```{r}
final.table <- subset(VarDescription, var %in% FinalVariableList)
final.table <- final.table[order(final.table$var, final.table$series), ] # sort by columns
final.table <- final.table[, c("var_desc", "var", "module", "tab_desc", "var_desc_ewas", "series")] # remove columns we don't care about
final.table <- as.data.frame(apply(final.table, 2, tolower), stringsAsFactors=F) # uniform lowercase descriptors
final.table <- aggregate(. ~ var, final.table, function(x) { toString(unique(x)) } ) # collapse multiple year entries per variable

final.table$var <- toupper(final.table$var) # pretty print formatting, uppercase var names

pie(sort(table(final.table$var_desc_ewas)), main="Variables to Analyze by Category")

# update with manually defined clinical categories
clinical_categories <- read.csv("~/src/phenome-mortality/clinical_categories.csv", stringsAsFactors=F)
final.table <- merge(final.table, clinical_categories[, c("dep_var", "category")], by.x="var", by.y="dep_var", all.x=T)
table(final.table$category)
```

With our final list of variables in hand we should revisit the `MainTable` that contained the patients to pare down the data to just include these final variable descriptors after we define covariates. First we need to derive two additional variables of interest, (1) number of times the patient received healthcare and (2) number of overnight visits to the hospital.

```{r}
# assume MainTable is the main data frame
table(MainTable$HUQ050, MainTable$SDDSRVYR) # for A, B, C, D, E, F, G: # times recieve healthcare over last year
table(MainTable$HUQ051, MainTable$SDDSRVYR) # for H: # times recieve healthcare over last year
MainTable$num_times_health_care <- NA
MainTable$num_times_health_care <- ifelse(MainTable$SDDSRVYR <= 7, MainTable$HUQ050, MainTable$HUQ051)
MainTable[which(MainTable$num_times_health_care > 10), 'num_times_health_care'] <- NA
MainTable[which(MainTable$num_times_health_care > 5), 'num_times_health_care'] <- 5

# number of overnight hospital visits
table(MainTable$HUQ070, MainTable$SDDSRVYR) # for A: Overnight hospital patient in last year
table(MainTable$HUD070, MainTable$SDDSRVYR) # for B: Overnight Hospital patient in last year
table(MainTable$HUQ071, MainTable$SDDSRVYR) # for C,D,E,F,G,H: Overnight Hospital patient in last year
table(MainTable$HUD080, MainTable$SDDSRVYR) # for A,C,D,E,F,G,H: Times overnite hospital patient last year
table(MainTable$HUQ080, MainTable$SDDSRVYR) # for B: Times overnite hospital patient last year

MainTable$overnight_in_hospital <- ifelse(MainTable$SDDSRVYR >= 3, MainTable$HUQ071, ifelse(MainTable$SDDSRVYR == 1, MainTable$HUQ070, MainTable$HUD070))
table(MainTable$overnight_in_hospital, MainTable$SDDSRVYR)

MainTable$times_overnight_in_hospital <- ifelse(MainTable$overnight_in_hospital == 2, 
                                                0, 
                                                ifelse(MainTable$SDDSRVYR == 2, 
                                                       MainTable$HUQ080,
                                                       MainTable$HUD080
                                                       )
                                                )
MainTable$times_overnight_in_hospital[which(MainTable$times_overnight_in_hospital >= 7)] <- NA
table(MainTable$times_overnight_in_hospital, MainTable$SDDSRVYR)
```

Codify top chronic conditions by CDC (heart disease, stroke, cancer, type 2 diabetes, obesity, and arthritis).

https://www.cdc.gov/chronicdisease/overview/index.htm

```{r}
chronic_conditions <- c(
                        "MCQ160B", # 1 HEART Has a doctor or other health professional ever told {you/SP} that {you/s/he} . . .had congestive heart failure?
                        "MCQ160C", # 1 HEART Has a doctor or other health professional ever told {you/SP} that {you/s/he} . . .had coronary heart disease?
                        "MCQ160E", # 1 HEART Has a doctor or other health professional ever told {you/SP} that {you/s/he} . . .had a heart attack (also called myocardial infarction)?
                        
                        "MCQ160F", # 2 STROKE Has a doctor or other health professional ever told {you/SP} that {you/s/he} . . .had a stroke?
                        
                        "MCQ220", # 3 CANCER {Have you/Has SP} ever been told by a doctor or other health professional that {you/s/he} had cancer or a malignancy of any kind?
                        
                        "DIQ010", # 4 T2D {Other than during pregnancy, {have you/has SP}/{Have you/Has SP}} ever been told by a doctor or health professional that {you have/{he/she/SP} has} diabetes or sugar diabetes?
                        
                        "MCQ080", # 5 OBESITY Has a doctor or other health professional ever told {you/SP} that {you were/s/he/SP was} overweight?
                        
                        "MCQ160A" # 6 ARTHRITIS Has a doctor or other health professional ever told {you/SP} that {you/s/he} . . .had arthritis?
                      )

MainTable$chronic <- 0 

# redo this loop, it's slow
for (i in 1:nrow(MainTable)) {
  #print(i) # debug super slow
  if ( any(MainTable[i, c(chronic_conditions)] == 1, na.rm=T) ) {
    MainTable$chronic[i] <- 1
  } else {
    MainTable$chronic[i] <- 0
  }
}

#MainTable[1:20, c(chronic_conditions, 'chronic')]
```

Part 1: age, sex, race/ethnicity, age^2. Part 2: chronic disease (self report), ratio of family income to poverty ([INDFMPIR](https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/DEMO_G.htm#INDFMPIR)).

```{r}
MainTable$RIDAGEYR2 <- NA # place holder, need to scale(RIDAGEYR)^2 for each cohort
adjustfor <- c('RIDAGEYR', 'RIDAGEYR2', 'RIAGENDR', 'INDFMPIR', 'RIDRETH1', 'num_times_health_care', 'times_overnight_in_hospital', 'chronic') # cleaned up to include just what we need
variablesToKeep <- c('PERMTH_EXM', 'MORTSTAT', adjustfor, FinalVariableList, 'SDDSRVYR', 'SDMVPSU', 'SDMVSTRA', 'WTMEC2YR', 'WTMEC4YR', 'area')

MainTable.2 <- MainTable[, colnames(MainTable) %in% variablesToKeep]

MainTable.2 <- as.data.frame(MainTable.2) # is a tibble, convert to df so legacy code works
MainTable.2.base <- MainTable.2 # store this variable as the cleaned data set for other iterations
```

Run this experiment where now MainTable.2 has values edited.

```{r eval=FALSE}
# case 0 just use the base data
MainTable.2 <- MainTable.2.base

# case 1 remove +/- 5% of values
remove_outliers <- function(x, cutoff=0.05, na.rm=TRUE, ...) {
  qnt <- quantile(x, probs=c(cutoff, (1-cutoff)), na.rm=na.rm, ...)
  y <- x
  y[x < qnt[1]] <- NA
  y[x > qnt[2]] <- NA
  
  return (y)
}

MainTable.2.outliers <- MainTable.2.base
for (var in FinalVariableList) {
  if (class(MainTable.2.outliers[, var]) == "numeric") {
    MainTable.2.outliers[, var] <- remove_outliers(MainTable.2.outliers[, var])
  }
}
MainTable.2 <- MainTable.2.outliers

# case 2 remove chronic
MainTable.2.chronic <- MainTable.2.base
MainTable.2.chronic <- subset(MainTable.2.chronic, chronic == 0)
MainTable.2 <- MainTable.2.chronic

# case 3 remove peopole who made medical visits last year
MainTable.2.visits <- MainTable.2.base
MainTable.2.visits <- subset(MainTable.2.visits, num_times_health_care == 0)
MainTable.2 <- MainTable.2.visits

# case 4 all of the above
MainTable.2.all <- MainTable.2.base
MainTable.2.all <- subset(MainTable.2.all, num_times_health_care == 0) # remove health care users
MainTable.2.all <- subset(MainTable.2.all, chronic == 0) # remove chronic conditions
for (var in FinalVariableList) {
  if (class(MainTable.2.all[, var]) == "numeric") {
    MainTable.2.all[, var] <- remove_outliers(MainTable.2.all[, var])
  }
}
MainTable.2 <- MainTable.2.all
```

How many people actually have mortality in the data compared to our subset? Look at distribution of time to censorship or death (`PERMTH_EXM`) then subset the patient list to those for the survey year (`SDDSRVYR`) of before or equal to 6 or earlier than the 2009-2010 (excluding 2011-2012 and 2013-2014).

```{r}
table(MainTable.2$SDDSRVYR)
MainTable.2 <- subset(MainTable.2, SDDSRVYR <= 6)
table(MainTable.2$SDDSRVYR)

table(MainTable$MORTSTAT, MainTable$SDDSRVYR)
hist(MainTable$PERMTH_EXM, breaks=55, main="Time to Censorship or Death", xlab="Days", col="green")
hist(MainTable.2$PERMTH_EXM, breaks=55, col="blue", add=T)
```

`PERMTH_EXM` doesn't change significantly after all the subsetting above, the distributions are almost identical visually and we confirm that quantitatively with a t.test below where p = 1.

```{r}
summary(MainTable$PERMTH_EXM)
summary(MainTable.2$PERMTH_EXM)

t.test(MainTable$PERMTH_EXM, MainTable.2$PERMTH_EXM)$p.value
```

Now let's make sure every variable is the correct data type.

```{r}
MainTable.2$RIAGENDR <- factor(MainTable.2$RIAGENDR, levels=c(1, 2), labels=c('m', 'f')) # Gender
MainTable.2$RIDRETH1 <- factor(MainTable.2$RIDRETH1, levels=c(3, 1, 2, 4, 5), labels=c("white", "mexam", "hispanic", "black", "other")) # Ethnicity
MainTable.2$RIDRETH1 <- relevel(MainTable.2$RIDRETH1, ref="white")
MainTable.2$SDDSRVYR <- factor(MainTable.2$SDDSRVYR, levels=c(1:6), labels=c("1999-2000", "2001-2002", "2003-2004", "2005-2006", "2007-2008", "2009-2010")) # Survey year
MainTable.2$SDMVPSU  <- factor(MainTable.2$SDMVPSU) # Primary Sampling Unit
MainTable.2$SDMVSTRA <- factor(MainTable.2$SDMVSTRA) # Sample strata
MainTable.2$area <- factor(MainTable.2$area) # Sample AREA

# Let's use the VarDescription table to help "systematically" factor variables
VarDescription.3$module <- tolower(VarDescription.3$module) # hack for inconsistencies in capitalization

# Examination variables with defined categories should be cast as factors
ManualCategoricalVariables <- subset(VarDescription.3, !is.na(categorical_levels))

# Manually verify, identify the class and then number of levels to confirm (quantitative variables have more)
unlist(lapply(MainTable.2[, colnames(MainTable.2) %in% ManualCategoricalVariables$var], class ))
unlist(lapply(MainTable.2[, colnames(MainTable.2) %in% ManualCategoricalVariables$var], function(x) {length(table(x))} ))

# only LBDTT3SI seems to be a concern, factor everything else
table(MainTable.2$LBDTT3SI)
ManualCategoricalVariables <- subset(ManualCategoricalVariables, var != "LBDTT3SI")
ManualCategoricalVariablesIndex <- which(colnames(MainTable.2) %in% ManualCategoricalVariables$var)

for (i in ManualCategoricalVariablesIndex) {
  MainTable.2[, i] <- factor(MainTable.2[, i])
}

# look at the rest
MainTable.2.classes <- unlist(lapply(MainTable.2, class))
MainTable.2.factor  <- names(MainTable.2.classes[MainTable.2.classes == "character"])
MainTable.2.integer <- names(MainTable.2.classes[MainTable.2.classes == "integer"])
MainTable.2.numeric <- names(MainTable.2.classes[MainTable.2.classes == "numeric"])

# characters are really factors
apply(MainTable.2[, MainTable.2.factor], 2, table)

sort(apply(MainTable.2[, MainTable.2.integer], 2, function(x) { length(table(x)) }))

for (i in MainTable.2.factor) {
  MainTable.2[, i] <- factor(MainTable.2[, i])
}
```

Do a scale and log transform of all quantitative variables.

```{r}
transform.cols <- which(colnames(MainTable.2) %in% FinalVariableList) # all potential variables
transform.cols <- setdiff(transform.cols, ManualCategoricalVariablesIndex) # remove all categorical variables
transform.cols <- setdiff(transform.cols, which(colnames(MainTable.2) %in% MainTable.2.factor)) # remove all other factors
transform.cols <- setdiff(transform.cols, which(colnames(MainTable.2) %in% MainTable.2.integer)) # remove all integers, may not be necessary

MainTable.cleaned <- cbind(MainTable.2[, !colnames(MainTable.2) %in% colnames(MainTable.2)[transform.cols]], apply(MainTable.2[, transform.cols], 2, function(x) { scale(x) }))
#MainTable.cleaned <- cbind(MainTable.2[, !colnames(MainTable.2) %in% colnames(MainTable.2)[transform.cols]], apply(MainTable.2[, transform.cols], 2, function(x) { scale(log(x+1e-10)) })) # log transform the data
```

Some heatmap action for correlation of the quantitative variables...this is time-intenseive, don't always run so set to `eval=FALSE` by default.

```{r eval=FALSE}
final.numeric.names <- colnames(MainTable.2)[transform.cols]

FinalVariableList.heat.raw <- matrix(NA, nrow=length(transform.cols), ncol=length(transform.cols), dimnames=list(final.numeric.names, final.numeric.names))
FinalVariableList.heat.log <- matrix(NA, nrow=length(transform.cols), ncol=length(transform.cols), dimnames=list(final.numeric.names, final.numeric.names))

for (i in 1:length(final.numeric.names)) {
  for (j in i:length(final.numeric.names)) {
    #print(paste(i, j))
    
    #tmp <- cbind( MainTable.2[final.numeric.names[i]], MainTable.2[final.numeric.names[j]] )
    #tmp <- tmp[complete.cases(tmp), ]
    #FinalVariableList.heat.raw[i, j] <- cor(tmp[, 1], tmp[, 2], use="everything", method="spearman")
    
    tmp <- cbind( MainTable.cleaned[final.numeric.names[i]], MainTable.cleaned[final.numeric.names[j]] )
    tmp <- tmp[complete.cases(tmp), ]
    FinalVariableList.heat.log[i, j] <- cor(tmp[, 1], tmp[, 2], use="everything", method="spearman")
  }
}
```

Code that just generates the heatmap (assuming the previous computationally intensive code block was run to generate pair-wise variable correlations).

```{r eval=FALSE}
# additional supporting libraries for pretty heatmap and color palettes
library(pheatmap)
library(RColorBrewer)

# make the matrix symmetrical (calculated only the upper.tri for efficiency)
FinalVariableList.heat.log[is.na(FinalVariableList.heat.log)] <- 0
FinalVariableList.heat <- FinalVariableList.heat.log + t(FinalVariableList.heat.log)
diag(FinalVariableList.heat) <- 1

# load manual clinical category annotations
final.table.clinical <- read.delim("~/src/phenome-mortality/FinalVariableList_041117.tsv", stringsAsFactors=F)
final.table.clinical <- final.table.clinical[final.table.clinical$var != "LBXSTR", ] # previously already removed but manually curated

annotation <- final.table.clinical[, c("var", "category")]
rownames(annotation) <- annotation$var
annotation$var <- NULL

annotation_colors <- unique(c(brewer.pal(9,"Set1"), brewer.pal(12, "Set3"))[1:length(unique(annotation$category))])
names(annotation_colors) <- unique(annotation$category)
annotation_colors <- list(category=annotation_colors)

pheatmap(FinalVariableList.heat, fontsize_row=5, fontsize_col=5, annotation_row=annotation, annotation_col=annotation, annotation_colors=annotation_colors, legend=T, annotation_legend=T, show_rownames=T, show_colnames=T, breaks=seq(-1,1,by=0.1), color=colorRampPalette(rev(brewer.pal(n=11, name="RdYlBu")))(20))

png(filename="heat.png", width=2500, height=2100, res=223)
pheatmap(FinalVariableList.heat, fontsize_row=5, fontsize_col=5, annotation_row=annotation, annotation_col=annotation, annotation_colors=annotation_colors, legend=T, annotation_legend=T, show_rownames=T, show_colnames=T, breaks=seq(-1,1,by=0.1), color=colorRampPalette(rev(brewer.pal(n=11, name="RdYlBu")))(20))
dev.off()
```

Sample analysis below.

```{r eval=FALSE}
## first, let us focus on each survey one at a time in males and females
glucose.m.1999 <- svycoxph(Surv(PERMTH_EXM, MORTSTAT) ~ I(scale(log(LBXGLU))) + RIDAGEYR + RIDAGEYR2 + factor(RIDRETH1, levels=c(3, 1, 2, 4, 5)), subset(dsn, RIAGENDR == 1 & SDDSRVYR == 1))
glucose.f.1999 <- svycoxph(Surv(PERMTH_EXM, MORTSTAT) ~ I(scale(log(LBXGLU))) + RIDAGEYR + RIDAGEYR2 + factor(RIDRETH1, levels=c(3, 1, 2, 4, 5)), subset(dsn, RIAGENDR == 2 & SDDSRVYR == 1))

summary(glucose.m.1999) ## HR of 1.2!: 20% increased risk for death
summary(glucose.f.1999) ## HR of 1.25: 25% increased risk for death, pretty close to males

reduced.mod <- coxph(Surv(PERMTH_EXM, MORTSTAT) ~ RIDAGEYR + male + black + mexican + other_hispanic + other_eth + cluster(area), dat, weights=dat$weight)
```

ALL THE DATA IS CLEANED, TIME TO XWAS!

Some demographic analysis.

```{r}
table(subset(MainTable.cleaned, !is.na(MORTSTAT))$SDDSRVYR) # individuals by cohort year

sum(table(subset(MainTable.cleaned, !is.na(MORTSTAT))$SDDSRVYR)) # total individuals over all years

# average age and standard deviation by cohort year
for (year in names(table(MainTable.cleaned$SDDSRVYR))) {
  cat(
    paste0(year, "\t",
           round(mean(subset(MainTable.cleaned, SDDSRVYR == year & !is.na(MORTSTAT))$RIDAGEYR), digits=1), " ", 
           "(", round(sd(subset(MainTable.cleaned, SDDSRVYR == year & !is.na(MORTSTAT))$RIDAGEYR), digits=1), ")"
           ), 
    "\n")
}

# male-female ratio
for (year in names(table(MainTable.cleaned$SDDSRVYR))) {
  cat(
    paste0(year, "\t",
           round(mean(subset(MainTable.cleaned, SDDSRVYR == year & !is.na(MORTSTAT))$RIAGENDR == 'm', na.rm=T)*100, digits=2), " "), 
    "\n")
}

# ethnicity by year, needs work to clarify!!!
for (year in names(table(MainTable.cleaned$SDDSRVYR))) {
  cat(
    paste0(year, "\t",
           round(table(subset(MainTable.cleaned, SDDSRVYR == year & !is.na(MORTSTAT))$RIDRETH1), digits=1), " ", 
           "(", round(prop.table(table(subset(MainTable.cleaned, SDDSRVYR == year & !is.na(MORTSTAT))$RIDRETH1))*100, digits=2), ")"
           ), 
    "\n")
}

# PIR < 1
for (year in names(table(MainTable.cleaned$SDDSRVYR))) {
  cat(
    paste0(year, "\t",
           round(mean(subset(MainTable.cleaned, SDDSRVYR == year & !is.na(MORTSTAT))$INDFMPIR < 1, na.rm=T)*100, digits=1)
           ),
    "\n")
}

# mortality
for (year in names(table(MainTable.cleaned$SDDSRVYR))) {
  cat(
    paste0(year, "\t",
           round(mean(subset(MainTable.cleaned, SDDSRVYR == year & !is.na(MORTSTAT))$MORTSTAT, na.rm=T)*100, digits=1)
           ),
    "\n")
}

# n healthcare
for (year in names(table(MainTable.cleaned$SDDSRVYR))) {
  cat(
    paste0(year, "\t",
           round(mean(subset(MainTable.cleaned, SDDSRVYR == year & !is.na(MORTSTAT))$num_times_health_care, na.rm=T), digits=1), " ", 
           "(", round(sd(subset(MainTable.cleaned, SDDSRVYR == year & !is.na(MORTSTAT))$num_times_health_care, na.rm=T), digits=1), ")"
           ), 
    "\n")
}
  
# n overnight hospital
for (year in names(table(MainTable.cleaned$SDDSRVYR))) {
  cat(
    paste0(year, "\t",
           round(mean(subset(MainTable.cleaned, SDDSRVYR == year & !is.na(MORTSTAT))$times_overnight_in_hospital, na.rm=T), digits=1), " ", 
           "(", round(sd(subset(MainTable.cleaned, SDDSRVYR == year & !is.na(MORTSTAT))$times_overnight_in_hospital, na.rm=T), digits=1), ")"
           ), 
    "\n")
}
```

Define some supporting functions.

```{r}
# convert xwas return list object to a data.frame with only beta and p-values for each co-variate
xwas2df <- function(surv) {
  #tmp <- lapply(surv, function(x) { return(x[1, c("exp(coef)", "Pr(>|z|)")]) } ) 
  tmp <- lapply(surv, function(x) { return(x[1, c("coef","exp(coef)", "robust se", "Pr(>|z|)")]) } ) 
  tmp <- data.frame(matrix(unlist(tmp), nrow=length(tmp), byrow=T))
  colnames(tmp) <- c("beta", "HR", "se", "p0")
  rownames(tmp) <- names(surv)
  
  # manually re-calculate p-values
  tmp$p <- pnorm(abs(tmp$beta/tmp$se), lower.tail=F)*2
  tmp <- tmp[order(tmp$beta), ] 
  
  return(tmp[complete.cases(tmp), ])
}

# main workhorse function
xwas <- function(design=NULL, linear=FALSE) {
  dat <- subset(design, WTMEC2YR > 0)
  total <- nrow(dat)
  
  surv <- list()
  
  for (varname in FinalVariableList) { # probably need to parameterize FinalVariableList
    baseformula <- NULL
    
    if (linear) {
      baseformula <- as.formula(sprintf('Surv(PERMTH_EXM, MORTSTAT) ~ I(%s) + cluster(area) + I(scale(RIDAGEYR)) + I(scale(RIDAGEYR)^2) + RIAGENDR + I(scale(INDFMPIR)) + I(scale(num_times_health_care)) + I(scale(times_overnight_in_hospital)) + RIDRETH1 + chronic', varname))
    } else {
      baseformula <- as.formula(sprintf('Surv(PERMTH_EXM, MORTSTAT) ~ pspline(%s, df=2) + cluster(area) + I(scale(RIDAGEYR)) + I(scale(RIDAGEYR)^2) + RIAGENDR + I(scale(INDFMPIR)) + I(scale(num_times_health_care)) + I(scale(times_overnight_in_hospital)) + RIDRETH1 + chronic', varname))
    }

    n <- sum( xtabs(~eval(as.symbol(depvar)) + eval(as.symbol(varname)), data=dat) )

    if (n/total > 0.01) {
      tryCatch( 
        surv[[varname]] <- coxph(baseformula, data=dat, weights=dat$WTMEC2YR)
        ,
        
        error=function(e) { 
          message(sprintf("ERROR: %s, %s", varname, e))
        }
        #, 
        #warning=function(w) {
        #  message(sprintf("WARNING: %s, %s", varname, w))
        #}
      )
    } else {
      cat(sprintf("skipping %s, total cases < 1%% of all data", varname), "\n")
    }
  }
  
  return(surv)
}

# takes return list object from xwas function and annotates co-variates with more verbose descriptions
annotate <- function(dat) {
  labels <- subset(VarDescription, var_desc_ewas %in% useTheseCategories)[, c("var", "var_desc", "var_desc_ewas")]
  labels <- labels[!duplicated(labels$var), ]
  rownames(labels) <- labels$var

  # match variables from the xwas output to the labels object
  dat <- merge(dat, labels, all.x=TRUE, by="row.names")
  rownames(dat) <- dat$Row.names
  dat$Row.names <- NULL
  
  return(dat)
}

cindexformodel <- function(mod, dat) {
	xx <- predict(mod)
	ss <- mod$y
	cStruct <- rcorr.cens(xx,ss)
	cStruct[1] <- (-cStruct[2]/2) + .5
	
	return(cStruct)
}

weightedr2 <- function(mod, useweight=T) {
	## unweighted method is in agreement with Harrell's implementation in ?validate (library Hmisc)
	## this is the same
	l0 <- mod$loglik[1]
	lr <- -2*(mod$loglik[1] - mod$loglik[2])
	n <- mod$n
	if (useweight) {
		n <- sum(mod$weights)
	}
	r2 <- (1-exp(-lr/n)) / (1-exp(2*l0/n))
	
	return(r2)
}
```

Baseline model to show that demographic variables captured in `adjustfor` are significant.

```{r}
baseline.mod <- coxph(Surv(PERMTH_EXM, MORTSTAT) ~ 
                        I(scale(RIDAGEYR))  + I(scale(RIDAGEYR)^2) + RIAGENDR + I(scale(INDFMPIR)) + 
                        I(scale(num_times_health_care)) + I(scale(times_overnight_in_hospital)) + 
                        RIDRETH1 + chronic + cluster(area), 
                        weights=MainTable.2$WTINT2YR, MainTable.2)

tidyBaseline <- tidy(baseline.mod, exponentiate=T)
tidyBaseline$HR <- sprintf('%.02f', tidyBaseline$estimate)
tidyBaseline$conf_int_string <- (sprintf('%.02f, %.02f', tidyBaseline$conf.low, tidyBaseline$conf.high))
#tmp$p <- pnorm(abs(tmp$beta/tmp$se), lower.tail=F)*2
#pnorm(abs(exp(tidyBaseline$estimate)/tidyBaseline$std.error), lower.tail=F)*2
tidyBaseline[, c('term', 'HR', 'conf_int_string', 'p.value')]
```

Prove that spline fitting is better than linear for our data using AIC.

```{r}
MainTable.cleaned <- subset(MainTable.cleaned, WTMEC2YR > 0)
surv.all.raw.linear <- xwas(design=MainTable.cleaned, linear=TRUE) 
surv.all.raw.spline <- xwas(design=MainTable.cleaned)
```

```{r}
l_vs_s <- data.frame(linear=NA, spline=NA)
set <- intersect(names(surv.all.raw.linear), names(surv.all.raw.spline))
for (i in set) {
  tmp <- data.frame(linear=AIC(surv.all.raw.linear[[i]]), spline=AIC(surv.all.raw.spline[[i]]))
  rownames(tmp) <- i
  
  l_vs_s[nrow(l_vs_s)+1, ] <- tmp
}
l_vs_s <- l_vs_s[-1, ]
l_vs_s$delta <- l_vs_s$linear - l_vs_s$spline

median(l_vs_s$delta, na.rm=TRUE)
# of the 120 variables the median delta is 564522.15 >>> 10

library("Rmpfr")
exp(-1*mpfr(l_vs_s$delta, precBits=4)/2)
# p(linear is a better model that minimizes information loss) <<< 1e-1000 %
```

```{r}
for (x in set) {
  print(paste("Plotting", x))
  tmp <- as.data.frame(MainTable.cleaned[, x])
  rownames(tmp) <- rownames(MainTable.cleaned)
  
  predicted <- predict(surv.all.raw.spline[[x]], x=MainTable.cleaned, type="terms", se.fit=T, terms=1)
  
  tmp <- merge(tmp, cbind(predicted$fit, predicted$se.fit), by="row.names")
  tmp <- tmp[, c(2,3,4)]
  tmp <- tmp[complete.cases(tmp), ]
  tmp <- tmp[order(tmp[, 1]), ]
  rownames(tmp) <- 1:nrow(tmp)
  colnames(tmp) <- c("var", "beta", "se")
  
  ## plot lines
  png(paste0("~/src/phenome-mortality/plot/", x, ".png"))
  plot( sm.spline(tmp$var, exp(tmp$beta)), type='l', frame.plot=F, xlab="SD", ylab="HR", main=x, xlim=c(-2,2))
  lines( sm.spline(tmp$var, exp(tmp$beta + 1.96 * tmp$se)), col="orange", lty=2)
  lines( sm.spline(tmp$var, exp(tmp$beta - 1.96 * tmp$se)), col="orange", lty=2)
  dev.off()
}
```

Now do survival analysis for all patients then subsetted by gender, poverty income ratio (PIR), full benefit retirement age (65), and race.

```{r}
#surv.all.coef <- lapply(surv.all.raw, function(x) { coef(summary(x)) }) # list of df
#surv.all.r2 <- lapply(surv.all.raw, function(x) { weightedr2(x) }) # list of df
#surv.all <- xwas2df(surv.all.coef) # df with beta, p, and q-values
#surv.all <- annotate(surv.all) # annotate with verbose descriptors
#surv.all.sig <- subset(surv.all, q < 0.05) # only FDR significant variables
#surv.all.sig <- surv.all.sig[order(surv.all.sig$beta), ] # sort by effect size

dsn.m <- subset(MainTable.cleaned, RIAGENDR == 'm') # male analysis
dsn.f <- subset(MainTable.cleaned, RIAGENDR == 'f') # female analysis

dsn.pir.above <- subset(dsn.all, INDFMPIR > 1) # PIR above analysis - WEALTHY
dsn.pir.below <- subset(dsn.all, INDFMPIR < 1) # PIR below analysis - POVERTY

dsn.age.above <- subset(dsn.all, RIDAGEYR >= 65) # age above analysis - OLD
dsn.age.below <- subset(dsn.all, RIDAGEYR <  65) # age below analysis - YOUNG

dsn.race.latin <- subset(dsn.all, RIDRETH1 == 1) # race analysis - LATIN (only mexican-american)
dsn.race.white <- subset(dsn.all, RIDRETH1 == 3) # race analysis - WHITE
dsn.race.black <- subset(dsn.all, RIDRETH1 == 4) # race analysis - BLACK

# for K-M plots
surv.m.raw <- xwas(design=dsn.m, adjfor=adjustfor[adjustfor != "RIAGENDR"])
surv.f.raw <- xwas(design=dsn.f, adjfor=adjustfor[adjustfor != "RIAGENDR"])

surv.pir.above.raw <- xwas(design=dsn.pir.above, adjfor=adjustfor[adjustfor != "INDFMPIR"])
surv.pir.below.raw <- xwas(design=dsn.pir.below, adjfor=adjustfor[adjustfor != "INDFMPIR"])

surv.age.above.raw <- xwas(design=dsn.age.above, adjfor=adjustfor[!(adjustfor %in% c("RIDAGEYR", "RIDAGEYR2"))])
surv.age.below.raw <- xwas(design=dsn.age.below, adjfor=adjustfor[!(adjustfor %in% c("RIDAGEYR", "RIDAGEYR2"))])

surv.race.latin.raw <- xwas(design=dsn.race.latin, adjfor=adjustfor[adjustfor != "RIDRETH1"])
surv.race.white.raw <- xwas(design=dsn.race.white, adjfor=adjustfor[adjustfor != "RIDRETH1"])
surv.race.black.raw <- xwas(design=dsn.race.black, adjfor=adjustfor[adjustfor != "RIDRETH1"])

# cohort analysis - looping through each study year
AvailableSeries <- names(table( dsn.all$variables$SDDSRVYR ))
for (i in 1:length(AvailableSeries)) {
  #eval(parse(text=paste0("MainTable.", "2")))
  cat("Now analyzing", useTheseSeries[i], "series.\n")
  
  # subset each substratified dsn survey further by year
  assign( paste0("dsn.all.", i),        subset(dsn.all,        SDDSRVYR == AvailableSeries[i]))
  assign( paste0("dsn.m.", i),          subset(dsn.m,          SDDSRVYR == AvailableSeries[i]))
  assign( paste0("dsn.f.", i),          subset(dsn.f,          SDDSRVYR == AvailableSeries[i]))
  assign( paste0("dsn.pir.above.", i),  subset(dsn.pir.above,  SDDSRVYR == AvailableSeries[i]))
  assign( paste0("dsn.pir.below.", i),  subset(dsn.pir.below,  SDDSRVYR == AvailableSeries[i]))
  assign( paste0("dsn.age.above.", i),  subset(dsn.age.above,  SDDSRVYR == AvailableSeries[i]))
  assign( paste0("dsn.age.below.", i),  subset(dsn.age.below,  SDDSRVYR == AvailableSeries[i]))
  assign( paste0("dsn.race.latin.", i), subset(dsn.race.latin, SDDSRVYR == AvailableSeries[i]))
  assign( paste0("dsn.race.white.", i), subset(dsn.race.white, SDDSRVYR == AvailableSeries[i]))
  assign( paste0("dsn.race.black.", i), subset(dsn.race.black, SDDSRVYR == AvailableSeries[i]))
  
  # survival analysis
  assign( paste0("surv.all.raw.", i), xwas(design=eval(parse(text=paste0("dsn.all.", i))), adjfor=adjustfor) ) 
  assign( paste0("surv.m.raw.", i),   xwas(design=eval(parse(text=paste0("dsn.m.", i))),   adjfor=adjustfor[adjustfor != "RIAGENDR"]) )
  assign( paste0("surv.f.raw.", i),   xwas(design=eval(parse(text=paste0("dsn.f.", i))),   adjfor=adjustfor[adjustfor != "RIAGENDR"]) )
  assign( paste0("surv.pir.above.raw.", i),  xwas(design=eval(parse(text=paste0("dsn.pir.above.", i))),  adjfor=adjustfor[adjustfor != "INDFMPIR"]) )
  assign( paste0("surv.pir.below.raw.", i),  xwas(design=eval(parse(text=paste0("dsn.pir.below.", i))),  adjfor=adjustfor[adjustfor != "INDFMPIR"]) )
  assign( paste0("surv.age.above.raw.", i),  xwas(design=eval(parse(text=paste0("dsn.age.above.", i))),  adjfor=adjustfor[!(adjustfor %in% c("RIDAGEYR", "RIDAGEYR2"))]) )
  assign( paste0("surv.age.below.raw.", i),  xwas(design=eval(parse(text=paste0("dsn.age.below.", i))),  adjfor=adjustfor[!(adjustfor %in% c("RIDAGEYR", "RIDAGEYR2"))]) )
  assign( paste0("surv.race.latin.raw.", i), xwas(design=eval(parse(text=paste0("dsn.race.latin.", i))), adjfor=adjustfor[adjustfor != "RIDRETH1"]) )
  assign( paste0("surv.race.white.raw.", i), xwas(design=eval(parse(text=paste0("dsn.race.white.", i))), adjfor=adjustfor[adjustfor != "RIDRETH1"]) )
  assign( paste0("surv.race.black.raw.", i), xwas(design=eval(parse(text=paste0("dsn.race.black.", i))), adjfor=adjustfor[adjustfor != "RIDRETH1"]) )
  
  assign( paste0("surv.all.coef.", i), lapply(eval(parse(text=paste0("surv.all.raw.", i))), function(x) { coef(summary(x)) }) ) # list of df
  assign( paste0("surv.m.coef.", i),   lapply(eval(parse(text=paste0("surv.m.raw.", i))), function(x) { coef(summary(x)) }) ) # list of df
  assign( paste0("surv.f.coef.", i),   lapply(eval(parse(text=paste0("surv.f.raw.", i))), function(x) { coef(summary(x)) }) ) # list of df
  assign( paste0("surv.pir.above.coef.", i),  lapply(eval(parse(text=paste0("surv.pir.above.raw.", i))),  function(x) { coef(summary(x)) }) ) # list of df
  assign( paste0("surv.pir.below.coef.", i),  lapply(eval(parse(text=paste0("surv.pir.below.raw.", i))),  function(x) { coef(summary(x)) }) ) # list of df
  assign( paste0("surv.age.above.coef.", i),  lapply(eval(parse(text=paste0("surv.age.above.raw.", i))),  function(x) { coef(summary(x)) }) ) # list of df
  assign( paste0("surv.age.below.coef.", i),  lapply(eval(parse(text=paste0("surv.age.below.raw.", i))),  function(x) { coef(summary(x)) }) ) # list of df
  assign( paste0("surv.race.latin.coef.", i), lapply(eval(parse(text=paste0("surv.race.latin.raw.", i))), function(x) { coef(summary(x)) }) ) # list of df
  assign( paste0("surv.race.white.coef.", i), lapply(eval(parse(text=paste0("surv.race.white.raw.", i))), function(x) { coef(summary(x)) }) ) # list of df
  assign( paste0("surv.race.black.coef.", i), lapply(eval(parse(text=paste0("surv.race.black.raw.", i))), function(x) { coef(summary(x)) }) ) # list of df
  
  assign( paste0("surv.all.", i),        annotate(xwas2df(eval(parse(text=paste0("surv.all.coef.", i))))) )
  assign( paste0("surv.m.", i),          annotate(xwas2df(eval(parse(text=paste0("surv.m.coef.", i))))) )
  
  ifelse(length(eval(parse(text=paste0("surv.f.coef.", i)))) > 0, 
         assign( paste0("surv.f.", i), annotate(xwas2df(eval(parse(text=paste0("surv.f.coef.", i)))))), 
         assign( paste0("surv.f.", i), list(NA)) )
  
  assign( paste0("surv.pir.above.", i),  annotate(xwas2df(eval(parse(text=paste0("surv.pir.above.coef.", i))))) )
  assign( paste0("surv.pir.below.", i),  annotate(xwas2df(eval(parse(text=paste0("surv.pir.below.coef.", i))))) )
  assign( paste0("surv.age.above.", i),  annotate(xwas2df(eval(parse(text=paste0("surv.age.above.coef.", i))))) )
  assign( paste0("surv.age.below.", i),  annotate(xwas2df(eval(parse(text=paste0("surv.age.below.coef.", i))))) )
  assign( paste0("surv.race.latin.", i), annotate(xwas2df(eval(parse(text=paste0("surv.race.latin.coef.", i))))) )

  ifelse(length(eval(parse(text=paste0("surv.race.white.coef.", i)))) > 0, 
         assign( paste0("surv.race.white.", i), annotate(xwas2df(eval(parse(text=paste0("surv.race.white.coef.", i)))))), 
         assign( paste0("surv.race.white.", i), list(NA)) )
  
  assign( paste0("surv.race.black.", i), annotate(xwas2df(eval(parse(text=paste0("surv.race.black.coef.", i))))) )
}
```

Do `metafor` analysis but first create some wrapper functions to process each substratified analysis.

```{r}
xmeta <- function(x) {
  #print(x)
  tmp <- c()
  for (i in 1:6) {
    tmp <- c(tmp, eval(parse(text=paste0(x, i)))$var)
  }
  meta.beta <- data.frame(var=unique(tmp))
  meta.se <- data.frame(var=unique(tmp))

  MissingSeries <- c()
  for (i in 1:6) {
    if ( length(eval(parse(text=paste0(x, i)))) == 8 ) {
      suppressWarnings( meta.beta <- merge(meta.beta, eval(parse(text=paste0(x, i)))[, c("beta", "var")], by="var", all.x=T) )
      suppressWarnings( meta.se <- merge(meta.se, eval(parse(text=paste0(x, i)))[, c("se", "var")], by="var", all.x=T) )
    } else {
      MissingSeries <- c(MissingSeries, i)
    }
  }
  
  if (length(MissingSeries) > 0) {
    ActualAvailableSeries <- AvailableSeries[AvailableSeries != AvailableSeries[MissingSeries]]
  } else {
    ActualAvailableSeries <- AvailableSeries
  }
  
  rownames(meta.beta) <- meta.beta$var
  rownames(meta.se) <- meta.se$var

  meta.beta$var <- NULL
  meta.se$var <- NULL
  
  colnames(meta.beta) <- c(ActualAvailableSeries)
  colnames(meta.se) <- c(ActualAvailableSeries)

  meta.all <- list() # stores all the meta analysis results
  meta.var <- rownames(meta.beta)[apply(meta.beta, 1, function(x) { table(complete.cases(x))["TRUE"] }) >= 2] # list of lab values that are significant in at least 2 cohorts

  for (i in meta.var) {
    #print(i)
    use <- complete.cases(t(meta.beta[i, ]))
    while ( is.null(meta.all[[i]]) ) {
      meta.all[[i]] <- tryCatch( {rma(yi=as.numeric(meta.beta[i, use]), sei=as.numeric(meta.se[i, use]), method="REML", slab=ActualAvailableSeries[use])}, error=function(e) {})
      
      if (table(use)["TRUE"] > 0) {
        use[which(as.numeric(meta.se[i, ]) == max(meta.se[i, use], na.rm=T))] <- FALSE
      } else {
        break
      }
    }
  }

  return(meta.all)
}

xmeta2df <- function(x) {
  meta.final <- c()
  
  for (i in x) {
    ### metafor extraction
    # overall effect, lower CI 95%, upper CI 95%, p-value, tau2, I2, k
    meta.final <- rbind(meta.final, c(i$b, i$ci.lb, i$ci.ub, i$pval, i$I2, i$k))
  }
  rownames(meta.final) <- names(x)
  colnames(meta.final) <- c("Effect", "Lower", "Upper", "p", "I2", "k") # label metafor analysis
  
  meta.final[, c("Effect")] <- exp(meta.final[, c("Effect")]) # convert beta coefficients to OR
  meta.final[, c("Lower")] <- exp(meta.final[, c("Lower")]) # convert lower beta estimate to OR
  meta.final[, c("Upper")] <- exp(meta.final[, c("Upper")]) # convert upper beta estimate to OR
  
  meta.final <- signif(meta.final, digits=3) # make values 3 significant figures
  
  meta.final <- merge(meta.final, VarDescription[match(unique(VarDescription$var), VarDescription$var), c("var", "var_desc")], by.x="row.names", by.y="var")
  rownames(meta.final) <- meta.final$Row.names
  meta.final$Row.names <- NULL
  
  meta.final$CI <- paste(meta.final$Lower, meta.final$Upper, sep=", ")
  
  Surveys <- as.data.frame(apply(VarSurveyCounts, 1, sum))
  names(Surveys) <- "Surveys"
  meta.final <- merge(meta.final, Surveys, by="row.names", all.x=T)
  rownames(meta.final) <- meta.final$Row.names
  meta.final$Row.names <- NULL
  meta.final <- meta.final[order(meta.final$Effect), ] # increasing OR
  
  return(meta.final[, c("var_desc", "Effect", "CI", "p", "I2", "k", "Surveys")]) # reorder df as it's returned
}
```

Now loop through each substratified analysis to do the meta-analysis.

```{r}
# x <- "surv.all.sig."
surv.all.meta.raw <- xmeta("surv.all.") # used to be surv.all.sig.
surv.all.meta     <- xmeta2df(surv.all.meta.raw)
surv.all.meta$q   <- p.adjust(surv.all.meta$p, method="BY")
surv.all.meta.sig <- subset(surv.all.meta, q < 0.05)

surv.m.meta.raw <- xmeta("surv.m.")
surv.m.meta     <- xmeta2df(surv.m.meta.raw)
surv.m.meta$q   <- p.adjust(surv.m.meta$p, method="BY")
surv.m.meta.sig <- subset(surv.m.meta, q < 0.05)
surv.f.meta.raw <- xmeta("surv.f.")
surv.f.meta     <- xmeta2df(surv.f.meta.raw)
surv.f.meta$q   <- p.adjust(surv.f.meta$p, method="BY")
surv.f.meta.sig <- subset(surv.f.meta, q < 0.05)

#View(surv.m.meta.sig[!(row.names(surv.m.meta.sig) %in% row.names(surv.f.meta.sig)), ]) # vars UNIQUE to men
#View(surv.f.meta.sig[!(row.names(surv.f.meta.sig) %in% row.names(surv.m.meta.sig)), ]) # vars UNIQUE to women

surv.age.above.meta.raw <- xmeta("surv.age.above.")
surv.age.above.meta     <- xmeta2df(surv.age.above.meta.raw)
surv.age.above.meta$q   <- p.adjust(surv.age.above.meta$p, method="BY")
surv.age.above.meta.sig <- subset(surv.age.above.meta, q < 0.05)
surv.age.below.meta.raw <- xmeta("surv.age.below.")
surv.age.below.meta     <- xmeta2df(surv.age.below.meta.raw)
surv.age.below.meta$q   <- p.adjust(surv.age.below.meta$p, method="BY")
surv.age.below.meta.sig <- subset(surv.age.below.meta, q < 0.05)

#View(surv.age.above.meta.sig[!(row.names(surv.age.above.meta.sig) %in% row.names(surv.age.below.meta.sig)), ]) # vars UNIQUE to old
#View(surv.age.below.meta.sig[!(row.names(surv.age.below.meta.sig) %in% row.names(surv.age.above.meta.sig)), ]) # vars UNIQUE to young

surv.pir.above.meta.raw <- xmeta("surv.pir.above.")
surv.pir.above.meta     <- xmeta2df(surv.pir.above.meta.raw)
surv.pir.above.meta$q   <- p.adjust(surv.pir.above.meta$p, method="BY")
surv.pir.above.meta     <- subset(surv.pir.above.meta, q < 0.05)
surv.pir.above.meta.sig <- subset(surv.pir.above.meta, q < 0.05)
surv.pir.below.meta.raw <- xmeta("surv.pir.below.")
surv.pir.below.meta     <- xmeta2df(surv.pir.below.meta.raw)
surv.pir.below.meta$q   <- p.adjust(surv.pir.below.meta$p, method="BY")
surv.pir.below.meta.sig <- subset(surv.pir.below.meta, q < 0.05)

#View(surv.pir.above.meta.sig[!(row.names(surv.pir.above.meta.sig) %in% row.names(surv.pir.below.meta.sig)), ]) # vars UNIQUE to rich
#View(surv.pir.below.meta.sig[!(row.names(surv.pir.below.meta.sig) %in% row.names(surv.pir.above.meta.sig)), ]) # vars UNIQUE to poor

surv.race.white.meta.raw <- xmeta("surv.race.white.")
surv.race.white.meta     <- xmeta2df(surv.race.white.meta.raw)
surv.race.white.meta$q   <- p.adjust(surv.race.white.meta$p, method="BY")
surv.race.white.meta.sig <- subset(surv.race.white.meta, q < 0.05)
surv.race.black.meta.raw <- xmeta("surv.race.black.")
surv.race.black.meta     <- xmeta2df(surv.race.black.meta.raw)
surv.race.black.meta$q   <- p.adjust(surv.race.black.meta$p, method="BY")
surv.race.black.meta.sig <- subset(surv.race.black.meta, q < 0.05)
surv.race.latin.meta.raw <- xmeta("surv.race.latin.")
surv.race.latin.meta     <- xmeta2df(surv.race.latin.meta.raw)
surv.race.latin.meta$q   <- p.adjust(surv.race.latin.meta$p, method="BY")
surv.race.latin.meta.sig <- subset(surv.race.latin.meta, q < 0.05)

#View(surv.race.white.meta.sig[!(row.names(surv.race.white.meta.sig) %in% c(row.names(surv.race.black.meta.sig), row.names(surv.race.latin.meta.sig))), ]) # vars UNIQUE to white
#View(surv.race.black.meta.sig[!(row.names(surv.race.black.meta.sig) %in% c(row.names(surv.race.white.meta.sig), row.names(surv.race.latin.meta.sig))), ]) # vars UNIQUE to black
#View(surv.race.latin.meta.sig[!(row.names(surv.race.latin.meta.sig) %in% c(row.names(surv.race.white.meta.sig), row.names(surv.race.black.meta.sig))), ]) # vars UNIQUE to latin
```

Collate case analyses, run each line separately as appropriate.

```{r eval=FALSE}
surv.all.meta.base <- surv.all.meta
surv.all.meta.outliers <- surv.all.meta # will fail on sub analysis but not relevant for this figure
surv.all.meta.chronic <- surv.all.meta
surv.all.meta.visits <- surv.all.meta

surv.all.meta.all <- surv.all.meta
```

```{r}
# case 1 outliers
df.outliers <- data.frame(vars=union(rownames(surv.all.meta.base), rownames(surv.all.meta.outliers)), stringsAsFactors=F)
rownames(df.outliers) <- df.outliers$vars

df.outliers <- merge(df.outliers, surv.all.meta.base[, c("var_desc", "Effect")], by=0, all.x=T)
rownames(df.outliers) <- df.outliers$Row.names
df.outliers$Row.names <- NULL
df.outliers$var_desc <- NULL

df.outliers <- merge(df.outliers, surv.all.meta.outliers[, c("var_desc", "Effect")], by=0, all.x=T)
rownames(df.outliers) <- df.outliers$Row.names
df.outliers$Row.names <- NULL
df.outliers$var_desc <- NULL

df.outliers[is.na(df.outliers)] <- 0
colnames(df.outliers) <- c("vars", "base", "outliers")
plot(outliers ~ base, data=df.outliers, xlim=c(0,2), ylim=c(0,2), xlab="Base", ylab="+/- 5%", main="Removing +/- 5% Values", frame.plot=F, pch=20)
abline(0, 1, col="gray60", lty=2)

# case 2 chronic 
df.chronic <- data.frame(vars=union(rownames(surv.all.meta.base), rownames(surv.all.meta.chronic)), stringsAsFactors=F)
rownames(df.chronic) <- df.chronic$vars

df.chronic <- merge(df.chronic, surv.all.meta.base[, c("var_desc", "Effect")], by=0, all.x=T)
rownames(df.chronic) <- df.chronic$Row.names
df.chronic$Row.names <- NULL
df.chronic$var_desc <- NULL

df.chronic <- merge(df.chronic, surv.all.meta.chronic[, c("var_desc", "Effect")], by=0, all.x=T)
rownames(df.chronic) <- df.chronic$Row.names
df.chronic$Row.names <- NULL
df.chronic$var_desc <- NULL

df.chronic[is.na(df.chronic)] <- 0
colnames(df.chronic) <- c("vars", "base", "chronic")
plot(chronic ~ base, data=df.chronic, xlim=c(0,2), ylim=c(0,2), xlab="Base", ylab="Chronic", main="Removing Chronic Disease", frame.plot=F, pch=20)
abline(0, 1, col="gray60", lty=2)

# case 3 remove people who used healthcare in the past year
df.visits <- data.frame(vars=union(rownames(surv.all.meta.base), rownames(surv.all.meta.visits)), stringsAsFactors=F)
rownames(df.visits) <- df.visits$vars

df.visits <- merge(df.visits, surv.all.meta.base[, c("var_desc", "Effect")], by=0, all.x=T)
rownames(df.visits) <- df.visits$Row.names
df.visits$Row.names <- NULL
df.visits$var_desc <- NULL

df.visits <- merge(df.visits, surv.all.meta.visits[, c("var_desc", "Effect")], by=0, all.x=T)
rownames(df.visits) <- df.visits$Row.names
df.visits$Row.names <- NULL
df.visits$var_desc <- NULL

df.visits[is.na(df.visits)] <- 0
colnames(df.visits) <- c("vars", "base", "visits")
plot(visits ~ base, data=df.visits, xlim=c(0,2), ylim=c(0,2), xlab="Base", ylab="Visits", main="Removing People w/Healthcare Last Year", frame.plot=F, pch=20)
abline(0, 1, col="gray60", lty=2)

# case 4 combine 1 through 3
df.all <- data.frame(vars=union(rownames(surv.all.meta.base), rownames(surv.all.meta.all)), stringsAsFactors=F)
rownames(df.all) <- df.all$vars

df.all <- merge(df.all, surv.all.meta.base[, c("var_desc", "Effect")], by=0, all.x=T)
rownames(df.all) <- df.all$Row.names
df.all$Row.names <- NULL
df.all$var_desc <- NULL

df.all <- merge(df.all, surv.all.meta.all[, c("var_desc", "Effect")], by=0, all.x=T)
rownames(df.all) <- df.all$Row.names
df.all$Row.names <- NULL
df.all$var_desc <- NULL

df.all[is.na(df.all)] <- 0
colnames(df.all) <- c("vars", "base", "all")
plot(all ~ base, data=df.all, xlim=c(0,3), ylim=c(0,3), xlab="Base", ylab="All", main="Combined", frame.plot=F, pch=20)
abline(0, 1, col="gray60", lty=2)

### combined
plot(all ~ base, data=df.all, xlim=c(0,3), ylim=c(0,3), xlab="Base HR", ylab="Metric HR", main="Substratified Health Indicators", frame.plot=F, pch=20, col=rgb(0,0,0, .3))
points(visits ~ base, data=df.visits, pch=20, col=rgb(.2,.8,.2, .3))
points(chronic ~ base, data=df.chronic, pch=20, col=rgb(1,.65,0, .3))
points(outliers ~ base, data=df.outliers, pch=20, col=rgb(0,0,1, .3))
abline(0, 1, col="gray60", lty=2)
legend("topright", legend=c("Combined", "Visits", "Chronic", "Outliers"), col=c(rgb(0,0,0, .5), rgb(.2,.8,.2, .5), rgb(1,.65,0, .5), rgb(0,0,1, .5)), pch=20, box.lwd=0, box.col="white", bg="white")
```

Create all forest plots.

```{r eval=FALSE}
metaforest <- function(x, group=NA, group_desc=NA, strata=NA) {
  for (i in names(x)) {
    png(file=paste0("~/src/phenome-mortality/gh-pages/forest/", group, "/", ifelse(!is.na(strata), paste0(strata, "/"), ""), i, ".png"))
    forest(x[[i]], main=paste0("\n\n\n\n\n", group_desc, "\n\n", VarDescription[VarDescription$var == i, ]$var_desc[1]))
    dev.off()
  }
}

metaforest(surv.all.meta.raw, group="all", group_desc="All-cause")

metaforest(surv.age.above.meta.raw, group="age", group_desc="Age (> 65)", strata="above")
metaforest(surv.age.below.meta.raw, group="age", group_desc="Age (< 65)", strata="below")

metaforest(surv.pir.above.meta.raw, group="pir", group_desc="Poverty:Income (> 1)", strata="above")
metaforest(surv.pir.below.meta.raw, group="pir", group_desc="Poverty:Income (< 1)", strata="below")

metaforest(surv.race.white.meta.raw, group="race", group_desc="Race (White)", strata="white")
metaforest(surv.race.black.meta.raw, group="race", group_desc="Race (Black)", strata="black")
metaforest(surv.race.latin.meta.raw, group="race", group_desc="Race (Mexican-American)", strata="latin")
```

###
# Supplemental Figures

Create UpSetR visualizations for comorbidities across time cohorts.

```{r}
# create space of all comorbidities found across everything ever
com.list.all <- c()
com.list.m   <- c()
com.list.f   <- c()
com.list.pir.above  <- c()
com.list.pir.below  <- c()
com.list.age.above  <- c()
com.list.age.below  <- c()
com.list.race.latin <- c()
com.list.race.white <- c()
com.list.race.black <- c()

for (i in 1:length(AvailableSeries)) {
  com.list.all <- union( com.list.all, rownames(eval(parse(text=paste0("surv.all.sig.", i)))) )
  com.list.m   <- union( com.list.m,   rownames(eval(parse(text=paste0("surv.m.sig.",   i)))) )
  com.list.f   <- union( com.list.f,   rownames(eval(parse(text=paste0("surv.f.sig.",   i)))) )
  com.list.pir.above  <- union( com.list.pir.above,  rownames(eval(parse(text=paste0("surv.pir.above.sig.",  i)))) )
  com.list.pir.below  <- union( com.list.pir.below,  rownames(eval(parse(text=paste0("surv.pir.below.sig.",  i)))) )
  com.list.age.above  <- union( com.list.age.above,  rownames(eval(parse(text=paste0("surv.age.above.sig.",  i)))) )
  com.list.age.below  <- union( com.list.age.below,  rownames(eval(parse(text=paste0("surv.age.below.sig.",  i)))) )
  com.list.race.latin <- union( com.list.race.latin, rownames(eval(parse(text=paste0("surv.race.latin.sig.", i)))) )
  com.list.race.white <- union( com.list.race.white, rownames(eval(parse(text=paste0("surv.race.white.sig.", i)))) )
  com.list.race.black <- union( com.list.race.black, rownames(eval(parse(text=paste0("surv.race.black.sig.", i)))) )
}

# create a list of booleans for presence of each time cohort in the union list of all comorbidities
com.df.all <- data.frame(com.list.all, stringsAsFactors=F)
com.df.m   <- data.frame(com.list.m,   stringsAsFactors=F)
com.df.f   <- data.frame(com.list.f,   stringsAsFactors=F)
com.df.pir.above  <- data.frame(com.list.pir.above,  stringsAsFactors=F)
com.df.pir.below  <- data.frame(com.list.pir.below,  stringsAsFactors=F)
com.df.age.above  <- data.frame(com.list.age.above,  stringsAsFactors=F)
com.df.age.below  <- data.frame(com.list.age.below,  stringsAsFactors=F)
com.df.race.latin <- data.frame(com.list.race.latin, stringsAsFactors=F)
com.df.race.white <- data.frame(com.list.race.white, stringsAsFactors=F)
com.df.race.black <- data.frame(com.list.race.black, stringsAsFactors=F)

for (i in 1:length(AvailableSeries)) {
  com.df.all <- cbind( com.df.all, com.list.all %in% rownames(eval(parse(text=paste0("surv.all.sig.", i)))) )
  com.df.m   <- cbind( com.df.m,   com.list.m   %in% rownames(eval(parse(text=paste0("surv.m.sig.",   i)))) )
  com.df.f   <- cbind( com.df.f,   com.list.f   %in% rownames(eval(parse(text=paste0("surv.f.sig.",   i)))) )
  com.df.pir.above  <- cbind( com.df.pir.above, com.list.pir.above   %in% rownames(eval(parse(text=paste0("surv.pir.above.sig.",  i)))) )
  com.df.pir.below  <- cbind( com.df.pir.below, com.list.pir.below   %in% rownames(eval(parse(text=paste0("surv.pir.below.sig.",  i)))) )
  com.df.age.above  <- cbind( com.df.age.above, com.list.age.above   %in% rownames(eval(parse(text=paste0("surv.age.above.sig.",  i)))) )
  com.df.age.below  <- cbind( com.df.age.below, com.list.age.below   %in% rownames(eval(parse(text=paste0("surv.age.below.sig.",  i)))) )
  com.df.race.latin <- cbind( com.df.race.latin, com.list.race.latin %in% rownames(eval(parse(text=paste0("surv.race.latin.sig.", i)))) )
  com.df.race.white <- cbind( com.df.race.white, com.list.race.white %in% rownames(eval(parse(text=paste0("surv.race.white.sig.", i)))) )
  com.df.race.black <- cbind( com.df.race.black, com.list.race.black %in% rownames(eval(parse(text=paste0("surv.race.black.sig.", i)))) )
}

# convert from boolean to 1 and 0 for UpSetR processing
com.df.all[, sapply(com.df.all, is.logical)] <- lapply(com.df.all[, sapply(com.df.all, is.logical)],   as.numeric)
com.df.m[,   sapply(com.df.m,   is.logical)] <- lapply(com.df.m[,   sapply(com.df.m,   is.logical)],   as.numeric)
com.df.f[,   sapply(com.df.f,   is.logical)] <- lapply(com.df.f[,   sapply(com.df.f,   is.logical)],   as.numeric)
com.df.pir.above[,  sapply(com.df.pir.above,  is.logical)] <- lapply(com.df.pir.above[,  sapply(com.df.pir.above,  is.logical)], as.numeric)
com.df.pir.below[,  sapply(com.df.pir.below,  is.logical)] <- lapply(com.df.pir.below[,  sapply(com.df.pir.below,  is.logical)], as.numeric)
com.df.age.above[,  sapply(com.df.age.above,  is.logical)] <- lapply(com.df.age.above[,  sapply(com.df.age.above,  is.logical)], as.numeric)
com.df.age.below[,  sapply(com.df.age.below,  is.logical)] <- lapply(com.df.age.below[,  sapply(com.df.age.below,  is.logical)], as.numeric)
com.df.race.latin[, sapply(com.df.race.latin, is.logical)] <- lapply(com.df.race.latin[, sapply(com.df.race.latin, is.logical)], as.numeric)
com.df.race.white[, sapply(com.df.race.white, is.logical)] <- lapply(com.df.race.white[, sapply(com.df.race.white, is.logical)], as.numeric)
com.df.race.black[, sapply(com.df.race.black, is.logical)] <- lapply(com.df.race.black[, sapply(com.df.race.black, is.logical)], as.numeric)

com.df.colnames <- c("Co-morbidity", AvailableSeries)
colnames(com.df.all) <- com.df.colnames
colnames(com.df.m)   <- com.df.colnames
colnames(com.df.f)   <- com.df.colnames
colnames(com.df.pir.above)  <- com.df.colnames
colnames(com.df.pir.below)  <- com.df.colnames
colnames(com.df.age.above)  <- com.df.colnames
colnames(com.df.age.below)  <- com.df.colnames
colnames(com.df.race.latin) <- com.df.colnames
colnames(com.df.race.white) <- com.df.colnames
colnames(com.df.race.black) <- com.df.colnames

# UpSetR metadata
usr.lbl.all <- data.frame(sets=colnames(com.df.all[2:ncol(com.df.all)]), CoM=unlist(strsplit(toString(apply(com.df.all[, 2:ncol(com.df.all)], 2, sum), row.names=NULL), ",")), stringsAsFactors=F)
usr.lbl.m   <- data.frame(sets=colnames(com.df.m[2:ncol(com.df.m)]), CoM=unlist(strsplit(toString(apply(com.df.m[,   2:ncol(com.df.m)],   2, sum), row.names=NULL), ",")), stringsAsFactors=F)
usr.lbl.f   <- data.frame(sets=colnames(com.df.f[2:ncol(com.df.f)]), CoM=unlist(strsplit(toString(apply(com.df.f[,   2:ncol(com.df.f)],   2, sum), row.names=NULL), ",")), stringsAsFactors=F)
usr.lbl.pir.above  <- data.frame(sets=colnames(com.df.pir.above[2:ncol(com.df.pir.above)]), CoM=unlist(strsplit(toString(apply(com.df.pir.above[,  2:ncol(com.df.pir.above)],  2, sum), row.names=NULL), ",")), stringsAsFactors=F)
usr.lbl.pir.below  <- data.frame(sets=colnames(com.df.pir.below[2:ncol(com.df.pir.below)]), CoM=unlist(strsplit(toString(apply(com.df.pir.below[,  2:ncol(com.df.pir.below)],  2, sum), row.names=NULL), ",")), stringsAsFactors=F)
usr.lbl.age.above  <- data.frame(sets=colnames(com.df.age.above[2:ncol(com.df.age.above)]), CoM=unlist(strsplit(toString(apply(com.df.age.above[,  2:ncol(com.df.age.above)],  2, sum), row.names=NULL), ",")), stringsAsFactors=F)
usr.lbl.age.below  <- data.frame(sets=colnames(com.df.age.below[2:ncol(com.df.age.below)]), CoM=unlist(strsplit(toString(apply(com.df.age.below[,  2:ncol(com.df.age.below)],  2, sum), row.names=NULL), ",")), stringsAsFactors=F)
usr.lbl.race.latin <- data.frame(sets=colnames(com.df.race.latin[2:ncol(com.df.race.latin)]), CoM=unlist(strsplit(toString(apply(com.df.race.latin[, 2:ncol(com.df.race.latin)], 2, sum), row.names=NULL), ",")), stringsAsFactors=F)
usr.lbl.race.white <- data.frame(sets=colnames(com.df.race.white[2:ncol(com.df.race.white)]), CoM=unlist(strsplit(toString(apply(com.df.race.white[, 2:ncol(com.df.race.white)], 2, sum), row.names=NULL), ",")), stringsAsFactors=F)
usr.lbl.race.black <- data.frame(sets=colnames(com.df.race.black[2:ncol(com.df.race.black)]), CoM=unlist(strsplit(toString(apply(com.df.race.black[, 2:ncol(com.df.race.black)], 2, sum), row.names=NULL), ",")), stringsAsFactors=F)

# visualize with UpSetR
upset(com.df.all, sets=c(rev(AvailableSeries)), keep.order=T, order.by="freq", sets.x.label="Significant Comorbidities \n (q < 0.05)", mainbar.y.label="Unique Comorbidities \n (All)", set.metadata=list(data=usr.lbl.all, plots=list(list(type="text", column="CoM", assign=10))))

upset(com.df.m, sets=c(rev(AvailableSeries)), keep.order=T, order.by="freq", sets.x.label="Significant Comorbidities \n (q < 0.05)", mainbar.y.label="Unique Comorbidities \n (Male)", set.metadata=list(data=usr.lbl.m, plots=list(list(type="text", column="CoM", assign=10))))

upset(com.df.f, sets=c(rev(AvailableSeries)), keep.order=T, order.by="freq", sets.x.label="Significant Comorbidities \n (q < 0.05)", mainbar.y.label="Unique Comorbidities \n (Female)", set.metadata=list(data=usr.lbl.f, plots=list(list(type="text", column="CoM", assign=10))))

upset(com.df.age.above, sets=c(rev(AvailableSeries)), keep.order=T, order.by="freq", sets.x.label="Significant Comorbidities \n (q < 0.05)", mainbar.y.label="Unique Comorbidities \n (Age > 65)", set.metadata=list(data=usr.lbl.age.above, plots=list(list(type="text", column="CoM", assign=10))))

upset(com.df.age.below, sets=c(rev(AvailableSeries)), keep.order=T, order.by="freq", sets.x.label="Significant Comorbidities \n (q < 0.05)", mainbar.y.label="Unique Comorbidities \n (Age < 65)", set.metadata=list(data=usr.lbl.age.below, plots=list(list(type="text", column="CoM", assign=10))))

upset(com.df.pir.above, sets=c(rev(AvailableSeries)), keep.order=T, order.by="freq", sets.x.label="Significant Comorbidities \n (q < 0.05)", mainbar.y.label="Unique Comorbidities \n (PIR > 1)", set.metadata=list(data=usr.lbl.pir.above, plots=list(list(type="text", column="CoM", assign=10))))

upset(com.df.pir.below, sets=c(rev(AvailableSeries)), keep.order=T, order.by="freq", sets.x.label="Significant Comorbidities \n (q < 0.05)", mainbar.y.label="Unique Comorbidities \n (PIR < 1)", set.metadata=list(data=usr.lbl.pir.below, plots=list(list(type="text", column="CoM", assign=10))))

upset(com.df.race.white, sets=c(rev(AvailableSeries)), keep.order=T, order.by="freq", sets.x.label="Significant Comorbidities \n (q < 0.05)", mainbar.y.label="Unique Comorbidities \n (White)", set.metadata=list(data=usr.lbl.race.white, plots=list(list(type="text", column="CoM", assign=10))))

upset(com.df.race.black, sets=c(rev(AvailableSeries)), keep.order=T, order.by="freq", sets.x.label="Significant Comorbidities \n (q < 0.05)", mainbar.y.label="Unique Comorbidities \n (Black)", set.metadata=list(data=usr.lbl.race.black, plots=list(list(type="text", column="CoM", assign=10))))

upset(com.df.race.latin, sets=c(rev(AvailableSeries)), keep.order=T, order.by="freq", sets.x.label="Significant Comorbidities \n (q < 0.05)", mainbar.y.label="Unique Comorbidities \n (Mexican-American)", set.metadata=list(data=usr.lbl.race.latin, plots=list(list(type="text", column="CoM", assign=10))))
```

Extra supplemental figures of volcano plots of all concatenated original regressions results across cohort years with the FDR significant highlighted at each cohort in orange and red for those that are ultimately meta-analysis significant across cohort years.

```{r}
volcano_cohort <- function(x) {
  p.all  <- c()
  hr.all <- c()
  p.ns   <- c()
  hr.ns  <- c()
  for (i in 1:6) {
    p.all  <- c(p.all,  eval(parse(text=paste0(x, i)))$p)
    hr.all <- c(hr.all, eval(parse(text=paste0(x, i)))$HR)
    
    p.ns   <- c(p.ns,  subset(eval(parse(text=paste0(x, i))), q > 0.05)$p)
    hr.ns  <- c(hr.ns, subset(eval(parse(text=paste0(x, i))), q > 0.05)$HR)
  }
  
  plot(hr.ns, -log10(p.ns), pch=20, col=rgb(0,0,0, alpha=0.25), 
       #xlim=c(0,max(hr.all)), 
       xlim=c(0,3),
       #ylim=c(0,max(-log10(p.all))), 
       ylim=c(0,20),
       xlab=c("HR"), ylab=expression("-log"[10]*"(p-value)"), frame.plot=F)
  abline(h=-log10(0.05), col="red", lty=2)
  
  p  <- c()
  hr <- c()
  for (i in 1:6) {
    p  <- c(p,  eval(parse(text=paste0(x, "sig.", i)))$p)
    hr <- c(hr, eval(parse(text=paste0(x, "sig.", i)))$HR)
    
    points(hr, -log10(p), pch=20, col=rgb(1,0,0, alpha=0.1))
  }
}

par(mfrow=c(1,1))
volcano_cohort("surv.all.")
#dev.off()

par(mfrow=c(1,2))
volcano_cohort("surv.m.")
volcano_cohort("surv.f.")
#dev.off()

par(mfrow=c(1,2))
volcano_cohort("surv.pir.above.")
volcano_cohort("surv.pir.below.")
#dev.off()

par(mfrow=c(1,2))
volcano_cohort("surv.age.above.")
volcano_cohort("surv.age.below.")
#dev.off()

par(mfrow=c(1,3))
volcano_cohort("surv.race.white.")
volcano_cohort("surv.race.black.")
volcano_cohort("surv.race.latin.")
#dev.off()

par(mfrow=c(1,1))
#dev.off()
```

Heatmap for only the 30 significant measures for mortality.

```{r}
baseline.heat <- FinalVariableList.heat[rownames(FinalVariableList.heat) %in% rownames(surv.all.meta.sig), colnames(FinalVariableList.heat) %in% rownames(surv.all.meta.sig)]

pheatmap(baseline.heat, fontsize_row=5, fontsize_col=5, annotation_row=annotation, annotation_col=annotation, annotation_colors=annotation_colors, legend=T, annotation_legend=T, show_rownames=T, show_colnames=T, breaks=seq(-1,1,by=0.1), color=colorRampPalette(rev(brewer.pal(n=11, name="RdYlBu")))(20))
```

Now test your significant list for r^2 values for all comorbidities.

```{r}
nagelkerke <- list()

for (i in 1:nrow(surv.all.meta.sig)) { # number of covariates in model
  print(paste("Sampling models with", i, "covariates."))
  samples <- c()
  
  for (j in 1:(3*nrow(surv.all.meta.sig))) { # sample the model with 'i' covariates 135 times (3 x total)
    baseformula <- as.formula(sprintf('Surv(%s, %s) ~ cluster(area)', "PERMTH_EXM", "MORTSTAT"))
    baseformula <- addToBase(baseformula, adjustfor)
    baseformula <- addToBase(baseformula, sample(rownames(surv.all.meta.sig), i))
    
    #print(baseformula) # debug our sample model
    #coxph(baseformula, data=dsn.all$variables, weights=1/dsn.all$allprob[, 1])  # changed to coxph
    
    r2 <- NA
    tryCatch({
        r2 <- weightedr2( coxph(baseformula, data=dsn.all$variables, weights=1/dsn.all$allprob[, 1]) )
      }, 
      warning=function(cond) {
        return()
      },
      error=function(cond) {
        return()
      },
      finally=function(cond) {
        return()
      }
    )
    samples <- c(samples, r2)
  }
  
  nagelkerke[[i]] <- samples
}
```

```{r}
barplot(unlist(lapply(nagelkerke, function(x) { sum(!is.na(x))/(length(nagelkerke)*3)*100 })), main="Viable Models per Number of Covariates", ylab="Viable Models (%)", xlab="Number of Model Covariates", ylim=c(0,100), las=2)

baseformula <- as.formula(sprintf('Surv(%s, %s) ~ cluster(area)', "PERMTH_EXM", "MORTSTAT"))
baseformula <- addToBase(baseformula, adjustfor)
r2 <- weightedr2( coxph(baseformula, data=dsn.all$variables, weights=1/dsn.all$allprob[, 1]) )
r2x <- unlist(lapply(nagelkerke, function(x) { mean(x, na.rm=T) }))

print(paste("Average Nagelkerke-R2 overall data is", mean(r2x, na.rm=T)))
print(paste("Base Model Nagelkerke-R2 overall data is", r2))


plot(c(1:length(nagelkerke))[!is.nan(r2x)], r2x[!is.nan(r2x)], xlab="No. of Model Covariates", ylab=expression(paste("Mean R"^"2")), xlim=c(0, length(nagelkerke)), ylim=c(0.08,0.15), las=1, frame.plot=F)
abline(h=r2, lty=2)
```

# Kaplan Meier Curves - All

```{r eval=FALSE} 
plot(1, type="n", xlab="Years", xlim=c(0, 156), ylab="Survival Probability", ylim=c(0.75, 1.00), las=1, main="All Cause - No Filter", frame.plot=F, axes=F)
axis(1, at=seq(0, 156, by=12), labels=c(0:13))
axis(2, at=seq(0.75, 1.00, by=0.05), las=1)
lapply(surv.all.raw, function(x) { lines(survfit(x, se.fit=F), col=rgb(0, 0, 0, 0.25)) } ) # plot all
```

```{r}
plot(1, type="n", xlab="Years", xlim=c(0, 156), ylab="Survival Probability", ylim=c(0.94, 1.00), las=1, main="All Cause", frame.plot=F, axes=F)
axis(1, at=seq(0, 156, by=12), labels=c(0:13))
axis(2, at=seq(0.94, 1.00, by=0.01), las=1)
lapply(surv.all.raw[row.names(surv.all.meta.sig)], function(x) { lines(survfit(x, se.fit=F), col=rgb(1, 0, 0, 0.25)) } )
```

# Kaplan Meier Curves - Gender

```{r}
plot(1, type="n", xlab="Years", xlim=c(0, 156), ylab="Survival Probability", ylim=c(0.94, 1.00), las=1, main="Gender Survival Curve", frame.plot=F, axes=F)
axis(1, at=seq(0, 156, by=12), labels=c(0:13))
axis(2, at=seq(0.94, 1.00, by=0.01), las=1)
lapply(surv.m.raw[row.names(surv.m.meta.sig)], function(x) { lines(survfit(x, se.fit=F), col=rgb(0, 0, 1, 0.25)) } )
lapply(surv.f.raw[row.names(surv.f.meta.sig)], function(x) { lines(survfit(x, se.fit=F), col=rgb(1, 0, 0, 0.25)) } )
legend("bottomleft", c("Male", "Female"), lty=c(1, 1), col=c("blue", "red"), bty='n')
```

# Kaplan Meier Curves - Age

```{r}
plot(1, type="n", xlab="Years", xlim=c(0, 156), ylab="Survival Probability", ylim=c(0.5, 1.00), las=1, main="Age Survival Curve", frame.plot=F, axes=F)
axis(1, at=seq(0, 156, by=12), labels=c(0:13))
axis(2, at=seq(0.5, 1.00, by=0.1), las=1)
lapply(surv.age.above.raw[row.names(surv.age.above.meta.sig)], function(x) { lines(survfit(x, se.fit=F), col=rgb(1, 0, 0, 0.25)) } )
lapply(surv.age.below.raw[row.names(surv.age.below.meta.sig)], function(x) { lines(survfit(x, se.fit=F), col=rgb(0, 0, 1, 0.25)) } )
legend("bottomleft", c("Older than 65", "Younger than 65"), lty=c(1, 1), col=c("red", "blue"), bty='n')
```

# Kaplan Meier Curves - Income

```{r}
plot(1, type="n", xlab="Years", xlim=c(0, 156), ylab="Survival Probability", ylim=c(0.90, 1.00), las=1, main="Poverty-Income Ratio Survival Curve", frame.plot=F, axes=F)
axis(1, at=seq(0, 156, by=12), label=c(0:13))
axis(2, at=seq(0.90, 1.00, by=0.02), las=1)
lapply(surv.pir.above.raw[row.names(surv.pir.above.meta.sig)], function(x) { lines(survfit(x, se.fit=F), col=rgb(1, 0, 0, 0.25)) } )
lapply(surv.pir.below.raw[row.names(surv.pir.below.meta.sig)], function(x) { lines(survfit(x, se.fit=F), col=rgb(0, 0, 1, 0.25)) } )
legend("bottomleft", c("Above poverty-income ratio", "Below poverty-income ratio"), lty=c(1, 1), col=c("red", "blue"), bty='n')
```

# Kaplan Meier Curves - Race

```{r}
plot(1, type="n", xlab="Years", xlim=c(0, 156), ylab="Survival Probability", ylim=c(0.94, 1.00), las=1, main="Race Survival Curve", frame.plot=F, axes=F)
axis(1, at=seq(0, 156, by=12), labels=c(0:13))
axis(2, at=seq(0.94, 1.00, by=0.01), las=1)
lapply(surv.race.white.raw[row.names(surv.race.white.meta.sig)], function(x) { lines(survfit(x, se.fit=F), col=rgb(1, 0, 0, 0.25)) } )
lapply(surv.race.black.raw[row.names(surv.race.black.meta.sig)], function(x) { lines(survfit(x, se.fit=F), col=rgb(0, 1, 0, 0.25)) } )
lapply(surv.race.latin.raw[row.names(surv.race.latin.meta.sig)], function(x) { lines(survfit(x, se.fit=F), col=rgb(0, 0, 1, 0.25)) } )
legend("bottomleft", c("White", "Black", "Mexican-American"), lty=c(1, 1), col=c("red", "green", "blue"), bty='n')
```

*** Additional visualizations ***

Visualize these effects by gender.

```{r eval=FALSE}
com.super.gender <- merge(com.all, surv.m.sig[, c("beta", "var")], by.x="var", by.y="var", all.x=T, suffixes=c("", ".m"))
com.super.gender <- merge(com.super.gender, surv.f.sig[, c("beta", "var")], by.x="var", by.y="var", all.x=T, suffixes=c("", ".f"))

plot(com.super.gender$beta.m, com.super.gender$beta.f, 
     xlab="Male", ylab="Female",
     frame.plot=F, xlim=c(-0.6, 0.6), ylim=c(-0.6, 0.6), pch=20)

abline(0, 1, col="gray60", lty=2)

points(subset(com.super.gender, var %in% com.m.only$var)$beta.m, subset(com.super.gender, var %in% com.m.only$var)$beta.f
       , col="blue", pch=20) # male only points
points(subset(com.super.gender, var %in% com.f.only$var)$beta.m, subset(com.super.gender, var %in% com.f.only$var)$beta.f
       , col="pink", pch=20) # female only points

text(subset(com.super.gender, var %in% com.m.only$var)$beta.m, subset(com.super.gender, var %in% com.m.only$var)$beta.f
     , labels=subset(com.super.gender, var %in% com.m.only$var)$var_desc, col="blue", cex=0.4, adj=c(-0.07,0.4))
text(subset(com.super.gender, var %in% com.f.only$var)$beta.m, subset(com.super.gender, var %in% com.f.only$var)$beta.f
     , labels=subset(com.super.gender, var %in% com.f.only$var)$var_desc, col="pink", cex=0.4, adj=c(1.15,0.4))
```

Supplemental figures of skewness.

```{r eval=FALSE}
library(e1071) # skewness library
library(reshape)
prebox <- subset(MainTable.2[, names(MainTable.2) %in% c("MORTSTAT", FinalVariableList)], !is.na(MORTSTAT))
tmp <- melt(prebox, id=c("MORTSTAT"))
tmp$MORTSTAT <- factor(tmp$MORTSTAT)
tmp$variable <- factor(tmp$variable)
tmp$value <- as.numeric(tmp$value)
boxplot(value ~ MORTSTAT*variable, data=subset(tmp, !is.na(value)))
```

Do some visualization using venn diagrams (should have loaded `venneuler`).

```{r eval=FALSE}
library(venneuler)  # venn diagrams 
MnF   <- table(c(rownames(surv.m.sig),   rownames(surv.f.sig))) > 1
AnM   <- table(c(rownames(surv.all.sig), rownames(surv.m.sig))) > 1
AnF   <- table(c(rownames(surv.all.sig), rownames(surv.f.sig))) > 1
AnMnF <- table(c(rownames(surv.all.sig), rownames(surv.m.sig), rownames(surv.m.sig))) > 2

OnlyA <- rownames(surv.all.sig)[!rownames(surv.all.sig) %in% c(rownames(surv.m.sig), rownames(surv.f.sig))]
OnlyM <- rownames(surv.m.sig)[!rownames(surv.m.sig) %in% c(rownames(surv.all.sig), rownames(surv.f.sig))]
OnlyF <- rownames(surv.f.sig)[!rownames(surv.f.sig) %in% c(rownames(surv.all.sig), rownames(surv.m.sig))]

vd <- venneuler(
    c(
      All=nrow(surv.all.sig), M=nrow(surv.m.sig), F=nrow(surv.f.sig),
      "M&F"=length(MnF[MnF]),
      "All&M"=length(AnM[AnM]),
      "All&F"=length(AnF[AnF]),
      "All&M&F"=length(AnMnF[AnMnF])
    )
  )

plot(vd)
```
